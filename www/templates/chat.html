<!DOCTYPE html>
<html>
	<head>
		<title>chat</title>
		<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.js"></script>
		<script type="text/javascript">
			$(function(){
				var conn = null;
				var name = 'UNKNOWN'
				Date.prototype.Format = function (fmt) { //author: meizz 
				var o = {
					"M+": this.getMonth() + 1, //月份 
					"d+": this.getDate(), //日 
					"h+": this.getHours(), //小时 
					"m+": this.getMinutes(), //分 
					"s+": this.getSeconds(), //秒 
					"q+": Math.floor((this.getMonth() + 3) / 3), //季度 
					"S": this.getMilliseconds() //毫秒 
				};
				if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
				for (var k in o)
					if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
					return fmt;
				}
				function log(msg){
					var log_panel = $('#log')
					log_panel.html(log_panel.html() + new Date().Format('yyyy-MM-dd HH:mm:ss') + ': ' + msg + '<br/>')
					log_panel.scrollTop(log_panel.scrollTop() + 1000);
				}
				function connect(){
					disconnect()
					var uri = (window.location.protocol=='https:'&&'wss://'||'ws://')+window.location.host + window.location.pathname;
					conn = new WebSocket(uri)
					conn.onopen = function(){
						updateUI()
					};
					conn.onmessage = function(e){
						var data = JSON.parse(e.data)
						switch(data.action) {
							case 'join':
								log('Joined ' + data.name);
								break
							case 'disconnect':
								name = data.name
								log('Disconnected ' + name);
								updateUI()
								break
							case 'connect':
								name = data.name
								log('Connected as ' + name);
								updateUI()
								break
							case 'sent':
								log(data.name + ': ' + data.text)
								break
						}
					};
					conn.onclose = function() {
						log('Disconnected')
						disconnect()
					};
				}
				function disconnect() {
					if(conn != null){
						conn.close()
						conn = null
						name = 'UNKNOWN'
						updateUI()
					}
				}
				function updateUI() {
					if (conn == null) {
						$('#status').text('disconnect')
						$('#connect').html('Connect')
						$('#send').prop('disable', true)
					} else {
						$('#status').text('connected (' + conn.protocol + ')');
						$('#connect').html('Disconnect');
						$('#send').prop("disabled", false);
					}
					$('#name').text(name);
				}
				$('#connect').on('click', function() {
					if (conn == null) {
						connect();
					} else {
						disconnect();
					}
					updateUI();
					return false;
				});
				$('#send').on('click', function() {
					var text = $('#text').val();
					// log('Sending: ' + text);
					log(text);
					conn.send(text);
					$('#text').val('').focus();
					return false;
				});
				$('#text').on('keyup', function(e) {
					if (e.keyCode === 13) {
						$('#send').click();
						return false;
					}
				});
			});
		</script>
	</head>
	<body>
		<div>
			<button id="connect">Connect</button>
			<span id="name">UNKNOWN</span>
			<span id="status">disconnect</span>
		</div>
		<div id="log" style="width:40em;height:15em;overflow:auto;border:1px solid black"></div>
		<form id="chat" onsubmit="return false">
			<input id="text" type="text">
			<input id="send" type="button" value="Send" disable>
		</form>
	</body>
</html>
